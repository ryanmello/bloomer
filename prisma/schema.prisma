datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Coupon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  codeName    String   @unique
  description String?
  discount    Float
  validUntil  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  firstName String?
  lastName  String?
  email     String  @unique
  password  String
  image     String?
  role      String?
  address1  String?
  address2  String?
  city      String?
  state     String?
  country   String?
  postal    String?
  phone     String?
  emailNotificationsEnabled Boolean @default(true)

  // Two-Factor Authentication
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?
  backupCodes      String[]

  // Password Reset
  passwordResetToken      String?
  passwordResetExpires    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shops             Shop[]
  coupons           Coupon[]
  campaigns         Campaign[]
  emailIntegrations EmailIntegration[]
  audiences         Audience[]
  event             Event[]
}

model Shop {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  userId  String @db.ObjectId
  name    String
  phone   String
  email   String
  address String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  customers Customer[]
  campaigns Campaign[]
  products  Product[]
  audiences Audience[]
  event     Event[]

}

model Customer {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  firstName      String
  lastName       String
  email          String    @unique
  phoneNumber    String?
  additionalNote String?
  addresses      Address[]
  squareId       String?
  orderCount     Int       @default(0)
  spendAmount    Float     @default(0)
  occasionsCount Int       @default(0)
  group          String?

  dateOfBirth   DateTime?
  birthMonth    Int?
  birthDay      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shopId String? @db.ObjectId
  shop   Shop?   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  campaignRecipients CampaignRecipient[]

  orders Order[]
  
}

model Order {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId String   @db.ObjectId
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  status      OrderStatus
  totalAmount Float       @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  notes String?
}

enum OrderStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

model Address {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  line1   String
  line2   String?
  city    String
  state   String
  zip     String
  country String

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String   @db.ObjectId
}

model Campaign {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  campaignName String
  subject      String
  emailBody    String

  // Status: Draft, Scheduled, Sent, Failed
  status String @default("Draft")

  // Target audience type: All, VIP, New, Potential, Newsletter, Custom
  audienceType String

  // For scheduled campaigns
  scheduledFor DateTime?
  sentAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  shopId String @db.ObjectId
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  recipients CampaignRecipient[]
}

model CampaignRecipient {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Email delivery status: Pending, Sent, Failed, Opened, Clicked
  status    String    @default("Pending")
  sentAt    DateTime?
  openedAt  DateTime?
  clickedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignId String   @db.ObjectId
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  customerId String   @db.ObjectId
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([campaignId, customerId])
}

model Product {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  category          String   @default("General")
  color             String?
  costPrice         Float
  retailPrice       Float
  quantity          Int      @default(0)
  lowInventoryAlert Int      @default(10)
  trackInventory    Boolean  @default(true)
  shelfLifeDays     Int?
  stemLength        String?
  image             String?
  isActive          Boolean  @default(true)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  shopId String @db.ObjectId
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  inventoryMovements InventoryMovement[]
}

model InventoryMovement {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  type              String // Type: "purchase", "sale", "adjustment", "waste", "return"
  quantity          Int // Positive for additions, negative for removals
  previousInventory Int
  newInventory      Int
  reason            String? // e.g., "Expired", "Damaged", "Customer order #123"
  referenceId       String? // Link to order/purchase if applicable
  notes             String?
  createdAt         DateTime @default(now())
  productId         String   @db.ObjectId
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  shopId            String   @db.ObjectId
}

enum AudienceStatus {
  active
  inactive
  draft
}

enum AudienceType {
  custom
  predefined
}

model Audience {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  status      AudienceStatus @default(draft)
  type        AudienceType   @default(custom)
  customerIds String[]       @default([])
  field       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shopId String? @db.ObjectId
  shop   Shop?   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailIntegration {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform      String   // "gmail" or "outlook"
  email         String   // The connected email address
  accessToken   String   // Encrypted access token
  refreshToken  String?  // Encrypted refresh token
  expiresAt     DateTime? // Token expiration time
  connected     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, platform])
}

model Event {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String?
  notes         String?
  start         DateTime
  end           DateTime
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String @db.ObjectId
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  shopId        String? @db.ObjectId
  shop          Shop?   @relation(fields: [shopId], references: [id], onDelete: Cascade)
}

